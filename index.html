<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Research Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scroll-container::-webkit-scrollbar { width: 4px; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 20px; }
        .analysis-card {
            background-color: rgba(55, 65, 81, 0.5); /* bg-gray-700/50 */
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid rgb(75 85 99);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                Smart Research Assistant
            </h1>
            <p class="text-gray-400 mt-2">Your AI-powered agent for academic writing.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <aside class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Controls</h2>
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-300 mb-2">Usage Dashboard</h3>
                    <div class="flex justify-around bg-gray-700 p-3 rounded-lg">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-blue-400" id="questions-counter">0</p>
                            <p class="text-sm text-gray-400">Questions</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-purple-400" id="reports-counter">0</p>
                            <p class="text-sm text-gray-400">Reports</p>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-300 mb-2">Upload Source Files</h3>
                    <form id="upload-form" class="bg-gray-700 p-4 rounded-lg">
                        <input type="file" id="file-input" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-3 transition duration-300">
                            Upload & Process
                        </button>
                    </form>
                    <div id="upload-status" class="mt-2 text-sm"></div>
                </div>
            </aside>

            <section class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg flex flex-col">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Draft Editor</h2>
                <textarea id="draft-editor" class="flex-1 w-full bg-gray-900 text-white p-4 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none scroll-container" placeholder="Start writing your paper here... The assistant will provide live feedback based on your uploaded sources."></textarea>
            </section>

            <aside class="lg:col-span-1 bg-gray-800 rounded-2xl shadow-lg flex flex-col">
                <div class="flex-1 p-6 overflow-y-auto scroll-container">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Live Analysis</h2>
                    <div id="analysis-output" class="space-y-4">
                        <div id="analysis-placeholder" class="text-center text-gray-500 py-16">
                            <p>Feedback will appear here as you type in the editor.</p>
                        </div>
                        <div id="analysis-loader" class="text-center text-gray-400 py-16 hidden">Analyzing...</div>
                        <div id="analysis-content" class="hidden space-y-4">
                            </div>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-700">
                    <h3 class="text-lg font-medium text-gray-300 mb-2">Ask a Question</h3>
                    <div id="qa-response" class="mb-3"></div>
                    <form id="question-form">
                        <textarea id="question-input" rows="2" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:outline-none resize-none" placeholder="Ask a specific question about your draft..."></textarea>
                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg mt-3 transition duration-300">
                            Get Answer
                        </button>
                    </form>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // --- DOM Elements ---
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const uploadStatus = document.getElementById('upload-status');
        const questionsCounter = document.getElementById('questions-counter');
        const reportsCounter = document.getElementById('reports-counter');
        const draftEditor = document.getElementById('draft-editor');
        const questionForm = document.getElementById('question-form');
        const questionInput = document.getElementById('question-input');
        const analysisOutput = document.getElementById('analysis-output');
        const analysisPlaceholder = document.getElementById('analysis-placeholder');
        const analysisLoader = document.getElementById('analysis-loader');
        const analysisContent = document.getElementById('analysis-content');
        const qaResponse = document.getElementById('qa-response');

        // --- Debounce Utility ---
        // This function prevents the analyzeDraft function from being called on every keystroke.
        // It will only run after the user has stopped typing for a specified delay.
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- Core Functions ---

        // Function to analyze the draft text
        async function analyzeDraft() {
            const draftContent = draftEditor.value.trim();
            if (draftContent.length < 50) { // Don't analyze very short texts
                analysisPlaceholder.classList.remove('hidden');
                analysisContent.classList.add('hidden');
                return;
            }

            analysisPlaceholder.classList.add('hidden');
            analysisLoader.classList.remove('hidden');
            analysisContent.classList.add('hidden');

            try {
                const response = await fetch('/api/live_analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ draft_content: draftContent }),
                });
                const result = await response.json();
                if (response.ok) {
                    displayAnalysis(result.analysis);
                }
            } catch (error) {
                console.error('Analysis Error:', error);
            } finally {
                analysisLoader.classList.add('hidden');
            }
        }
        const debouncedAnalyze = debounce(analyzeDraft, 1500); // 1.5 second delay

        // Function to ask a specific question
        async function askQuestion(e) {
            e.preventDefault();
            const question = questionInput.value.trim();
            const draftContext = draftEditor.value.trim();
            if (!question) return;

            qaResponse.innerHTML = `<p class="text-sm text-blue-400">Getting answer...</p>`;
            
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, draft_context: draftContext }),
                });
                const result = await response.json();
                if (result.success) {
                    qaResponse.innerHTML = `<div class="analysis-card text-gray-300">${result.summary}</div>`;
                } else {
                    qaResponse.innerHTML = `<p class="text-sm text-red-400">${result.error || 'Failed to get answer.'}</p>`;
                }
            } catch (error) {
                qaResponse.innerHTML = `<p class="text-sm text-red-400">An error occurred.</p>`;
            } finally {
                updateStats();
            }
        }
        
        // --- UI Display Functions ---

        function displayAnalysis(analysis) {
            if (!analysis) return;
            analysisContent.classList.remove('hidden');
            analysisContent.innerHTML = ''; // Clear previous results

            // 1. Potential Citations
            let citationsHtml = '<div class="analysis-card"><h4 class="font-semibold text-blue-400 mb-2">Potential Citations</h4>';
            if (analysis.potential_citations && analysis.potential_citations.length > 0) {
                citationsHtml += '<ul class="space-y-3 text-sm">';
                analysis.potential_citations.forEach(cit => {
                    citationsHtml += `<li class="border-b border-gray-600 pb-2">
                        <p class="text-gray-300"><strong>Claim:</strong> "${cit.claim_in_draft}"</p>
                        <p class="text-gray-400 mt-1"><strong>Supporting Quote:</strong> "${cit.supporting_quote_from_context}"</p>
                        <p class="text-xs text-purple-400 mt-1">Source: ${cit.source}</p>
                    </li>`;
                });
                citationsHtml += '</ul>';
            } else {
                citationsHtml += '<p class="text-sm text-gray-500">No direct citations found for your draft.</p>';
            }
            citationsHtml += '</div>';
            analysisContent.innerHTML += citationsHtml;

            // 2. Unsupported Claims
            let unsupportedHtml = '<div class="analysis-card"><h4 class="font-semibold text-yellow-400 mb-2">Unsupported Claims</h4>';
            if (analysis.unsupported_claims && analysis.unsupported_claims.length > 0) {
                 unsupportedHtml += '<ul class="list-disc list-inside text-sm text-gray-300 space-y-1">';
                 analysis.unsupported_claims.forEach(claim => {
                     unsupportedHtml += `<li>${claim}</li>`;
                 });
                 unsupportedHtml += '</ul><p class="text-xs text-gray-500 mt-2">These claims could not be verified against the uploaded sources.</p>';
            } else {
                 unsupportedHtml += '<p class="text-sm text-gray-500">All claims appear to be supported by the sources.</p>';
            }
            unsupportedHtml += '</div>';
            analysisContent.innerHTML += unsupportedHtml;

            // ... Add similar blocks for 'related_papers' and 'validation_feedback' if needed
        }
        
        async function handleUpload(e) {
            e.preventDefault();
            const file = fileInput.files[0];
            if (!file) {
                uploadStatus.textContent = 'Please select a file.';
                uploadStatus.className = 'mt-2 text-sm text-red-400';
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            uploadStatus.textContent = 'Uploading and processing...';
            uploadStatus.className = 'mt-2 text-sm text-blue-400';
            try {
                const response = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await response.json();
                const message = response.ok ? result.success : (result.error || 'Upload failed.');
                const colorClass = response.ok ? 'text-green-400' : 'text-red-400';
                uploadStatus.textContent = message;
                uploadStatus.className = `mt-2 text-sm ${colorClass}`;
            } catch (error) {
                uploadStatus.textContent = 'An error occurred during upload.';
                uploadStatus.className = 'mt-2 text-sm text-red-400';
            }
        }
        
        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                questionsCounter.textContent = stats.questions_asked;
                reportsCounter.textContent = stats.reports_generated;
            } catch (error) {
                console.error('Failed to fetch stats:', error);
            }
        }

        // --- Event Listeners ---
        draftEditor.addEventListener('input', debouncedAnalyze);
        uploadForm.addEventListener('submit', handleUpload);
        questionForm.addEventListener('submit', askQuestion);
        document.addEventListener('DOMContentLoaded', updateStats);
    </script>
</body>
</html>