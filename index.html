<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Research Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap(https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap)" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scroll-container::-webkit-scrollbar { width: 4px; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 20px; }
        .analysis-card {
            background-color: rgba(55, 65, 81, 0.5); /* bg-gray-700/50 */
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid rgb(75 85 99);
        }
        details > summary {
            list-style: none;
            cursor: pointer;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                Smart Research Assistant
            </h1>
            <p class="text-gray-400 mt-2">Your AI-powered agent for academic writing.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <aside class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Controls</h2>
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-300 mb-2">Usage Dashboard</h3>
                    <div class="flex justify-around bg-gray-700 p-3 rounded-lg">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-blue-400" id="questions-counter">0</p>
                            <p class="text-sm text-gray-400">Questions</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-purple-400" id="reports-counter">0</p>
                            <p class="text-sm text-gray-400">Reports</p>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-300 mb-2">Upload Source Files</h3>
                    <form id="upload-form" class="bg-gray-700 p-4 rounded-lg">
                        <input type="file" id="file-input" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                        <button type="submit" id="upload-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-3 transition duration-300">
                            Upload & Process
                        </button>
                    </form>
                    <div id="upload-status" class="mt-2 text-sm"></div>
                    <div id="ocr-progress" class="mt-3 p-3 bg-yellow-900/20 border border-yellow-600 rounded-lg hidden">
                        <div class="flex items-center mb-2">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-400 mr-2"></div>
                            <span class="text-yellow-400 font-medium">OCR Processing in Progress...</span>
                        </div>
                        <p class="text-sm text-yellow-300 mb-2">This PDF requires OCR text extraction. This process may take 1-2 minutes depending on the file size.</p>
                        <div class="w-full bg-yellow-900 rounded-full h-2">
                            <div id="ocr-progress-bar" class="bg-yellow-400 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <p id="ocr-status-text" class="text-xs text-yellow-400 mt-1">Initializing OCR...</p>
                    </div>
                </div>
            </aside>

            <section class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg flex flex-col">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Draft Editor</h2>
                <textarea id="draft-editor" class="flex-1 w-full bg-gray-900 text-white p-4 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none scroll-container" placeholder="Start writing your paper here... The assistant will provide live feedback based on your uploaded sources."></textarea>
            </section>

            <aside class="lg:col-span-1 bg-gray-800 rounded-2xl shadow-lg flex flex-col">
                <div class="flex-1 p-6 overflow-y-auto scroll-container">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                            <h2 class="text-2xl font-semibold">Live Analysis</h2>
                            <button id="export-button" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-sm rounded-lg transition duration-300">
                                Export Report
                            </button>
                        </div>
                    <div id="analysis-output" class="space-y-4">
                        <div id="analysis-placeholder" class="text-center text-gray-500 py-16">
                            <p>Feedback will appear here as you type in the editor.</p>
                        </div>
                        <div id="analysis-loader" class="text-center text-gray-400 py-16 hidden">Analyzing...</div>
                        <div id="analysis-content" class="hidden space-y-4">
                            </div>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-700">
                    <h3 class="text-lg font-medium text-gray-300 mb-2">Ask a Question</h3>
                    <div id="qa-response" class="mb-3"></div>
                    <form id="question-form">
                        <textarea id="question-input" rows="2" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:outline-none resize-none" placeholder="Ask a specific question about your draft..."></textarea>
                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg mt-3 transition duration-300">
                            Get Answer
                        </button>
                    </form>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // --- DOM Elements ---
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const uploadStatus = document.getElementById('upload-status');
        const ocrProgress = document.getElementById('ocr-progress');
        const ocrProgressBar = document.getElementById('ocr-progress-bar');
        const ocrStatusText = document.getElementById('ocr-status-text');
        const questionsCounter = document.getElementById('questions-counter');
        const reportsCounter = document.getElementById('reports-counter');
        const draftEditor = document.getElementById('draft-editor');
        const questionForm = document.getElementById('question-form');
        const questionInput = document.getElementById('question-input');
        const analysisContent = document.getElementById('analysis-content');
        const analysisPlaceholder = document.getElementById('analysis-placeholder');
        const analysisLoader = document.getElementById('analysis-loader');
        const qaResponse = document.getElementById('qa-response');
        const exportButton = document.getElementById('export-button');

        let currentReportData = null;
        // --- Debounce Utility ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- Core Functions ---

        async function analyzeDraft() {
            const draftContent = draftEditor.value.trim();
            if (draftContent.length < 50) {
                analysisPlaceholder.classList.remove('hidden');
                analysisContent.classList.add('hidden');
                return;
            }
            analysisPlaceholder.classList.add('hidden');
            analysisLoader.classList.remove('hidden');
            analysisContent.classList.add('hidden');
            try {
                const response = await fetch('/api/live_analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ draft_content: draftContent }),
                });
                const result = await response.json();
                //if (response.ok) {
                    //displayAnalysis(result); // Pass the whole result object
                //}
                if (response.ok && result.success) {
                    currentReportData = { type: 'analysis', data: result,draft: draftEditor.value.trim() }; // Store data for export
                    exportButton.classList.remove('hidden'); // Show export button
                    displayAnalysis(result);
                }
            } catch (error) {
                console.error('Analysis Error:', error);
            } finally {
                analysisLoader.classList.add('hidden');
            }
        }
        const debouncedAnalyze = debounce(analyzeDraft, 1500);

        async function askQuestion(e) {
            e.preventDefault();
            const question = questionInput.value.trim();
            const draftContext = draftEditor.value.trim();
            if (!question) return;
            qaResponse.innerHTML = `<p class="text-sm text-blue-400">Getting answer...</p>`;
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, draft_context: draftContext }),
                });
                const result = await response.json();
                // --- UPDATED: Render Q&A response with sources ---
                if (result.success) {
                    currentReportData = { type: 'qa', data: result, question: questionInput.value.trim() }; // Store data for export
                    exportButton.classList.remove('hidden'); // Show export button
                    
                    let sourcesHtml = '';
                    if (result.sources && result.sources.length > 0) {
                        sourcesHtml = '<h4 class="font-semibold text-gray-400 mt-4 mb-2">Sources Consulted</h4>' +
                            result.sources.map(s => createSourceDetailHtml(s.source, s.content)).join('');
                    }
                    qaResponse.innerHTML = `<div class="analysis-card">
                        <p class="text-gray-300">${result.summary}</p>
                        ${sourcesHtml}
                    </div>`;
                } else {
                    qaResponse.innerHTML = `<p class="text-sm text-red-400">${result.error || 'Failed to get answer.'}</p>`;
                }
            } catch (error) {
                qaResponse.innerHTML = `<p class="text-sm text-red-400">An error occurred.</p>`;
            } finally {
                updateStats();
            }
        }


        function exportReport() {
            if (!currentReportData) {
                alert("No report data available to export.");
                return;
            }

            
            const { type, data } = currentReportData;

            const styles = `
                <style>
                    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #111827; color: #d1d5db; line-height: 1.6; }
                    .container { max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: #1f2937; border-radius: 8px; border: 1px solid #374151; }
                    h1 { color: #93c5fd; border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; }
                    h2 { color: #a5b4fc; border-bottom: 1px solid #4f46e5; padding-bottom: 0.3rem; margin-top: 2rem; }
                    h3 { color: #f9a8d4; }
                    ul { list-style-type: none; padding-left: 0; }
                    li { background-color: #374151; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
                    blockquote { border-left: 4px solid #6b7280; padding-left: 1rem; margin-left: 0; font-style: italic; color: #9ca3af; }
                    .source { font-size: 0.8rem; color: #a5b4fc; }
                </style>
            `;

            // 2. Build the HTML body of the report
            let bodyHtml = `<body><div class="container">`;
            bodyHtml += `<h1>Smart Research Assistant Report</h1>`;

            if (type === 'analysis') {
                bodyHtml += `<h2>Live Analysis of Draft</h2>`;
                bodyHtml += `<h3>Potential Citations</h3>`;
                if (data.analysis.potential_citations && data.analysis.potential_citations.length > 0) {
                    bodyHtml += '<ul>';
                    data.analysis.potential_citations.forEach(c => {
                        bodyHtml += `<li>
                            <p><strong>Claim:</strong> "${c.claim_in_draft}"</p>
                            <blockquote>${c.supporting_quote_from_context}</blockquote>
                            <p class="source">Source: ${c.source}</p>
                        </li>`;
                    });
                    bodyHtml += '</ul>';
                } else {
                    bodyHtml += '<p>No direct citations found.</p>';
                }
                
                bodyHtml += `<h3>Unsupported Claims</h3>`;
                if (data.analysis.unsupported_claims && data.analysis.unsupported_claims.length > 0) {
                     bodyHtml += '<ul>';
                     data.analysis.unsupported_claims.forEach(claim => { bodyHtml += `<li>${claim}</li>`; });
                     bodyHtml += '</ul>';
                } else {
                    bodyHtml += '<p>All claims appear to be supported.</p>';
                }

            } else if (type === 'qa') {
                bodyHtml += `<h2>Q&A Report</h2>`;
                bodyHtml += `<p><strong>Question:</strong> ${currentReportData.question}</p>`;
                bodyHtml += `<h3>Summary</h3><p>${data.summary}</p>`;
                bodyHtml += `<h3>Sources Consulted</h3>`;
                if (data.sources && data.sources.length > 0) {
                    bodyHtml += '<ul>';
                    data.sources.forEach(s => {
                        bodyHtml += `<li>
                            <p class="source"><strong>Source:</strong> ${s.source.split(/[\\/]/).pop()}</p>
                            <blockquote>${s.content}</blockquote>
                        </li>`;
                    });
                    bodyHtml += '</ul>';
                } else {
                    bodyHtml += "<p>No sources were consulted.</p>";
                }
            }

            bodyHtml += `</div></body>`;

            // 3. Combine everything and trigger the download as an .html file
            const fullHtml = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Research Report</title>${styles}</head>${bodyHtml}</html>`;
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'research-report.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        
        // --- UI Display Functions ---

        // ---  Helper to create expandable source snippets ---
        function createSourceDetailHtml(sourceName, content) {
            const cleanSourceName = sourceName.split(/[\\/]/).pop(); // Get just the filename
            return `
                <details class="text-sm bg-gray-900/50 rounded p-2 mt-1">
                    <summary class="flex justify-between items-center font-medium text-purple-400">
                        <span>${cleanSourceName}</span>
                        <span class="text-xs text-gray-500">Click to expand</span>
                    </summary>
                    <div class="mt-2 pt-2 border-t border-gray-600 text-gray-400 whitespace-pre-wrap">${content}</div>
                </details>
            `;
        }

        function displayAnalysis(result) {
            const analysis = result.analysis;
            if (!analysis) return;
            analysisContent.classList.remove('hidden');
            analysisContent.innerHTML = '';

            let finalHtml = '';

            // 1. Potential Citations
            let citationsHtml = '<div class="analysis-card"><h4 class="font-semibold text-blue-400 mb-2">Potential Citations</h4>';
            if (analysis.potential_citations && analysis.potential_citations.length > 0) {
                citationsHtml += '<ul class="space-y-3 text-sm">';
                analysis.potential_citations.forEach(cit => {
                    citationsHtml += `<li class="border-b border-gray-600 pb-2">
                        <p class="text-gray-300"><strong>Claim:</strong> "${cit.claim_in_draft}"</p>
                        <p class="text-gray-400 mt-1"><strong>Supporting Quote:</strong> "${cit.supporting_quote_from_context}"</p>
                        <p class="text-xs text-purple-400 mt-1">Source: ${cit.source}</p>
                    </li>`;
                });
                citationsHtml += '</ul>';
            } else {
                citationsHtml += '<p class="text-sm text-gray-500">No direct citations found for your draft.</p>';
            }
            citationsHtml += '</div>';
            finalHtml += citationsHtml;

            // 2. Unsupported Claims
            let unsupportedHtml = '<div class="analysis-card"><h4 class="font-semibold text-yellow-400 mb-2">Unsupported Claims</h4>';
            if (analysis.unsupported_claims && analysis.unsupported_claims.length > 0) {
                 unsupportedHtml += '<ul class="list-disc list-inside text-sm text-gray-300 space-y-1">';
                 analysis.unsupported_claims.forEach(claim => {unsupportedHtml += `<li>${claim}</li>`;});
                 unsupportedHtml += '</ul><p class="text-xs text-gray-500 mt-2">These claims could not be verified.</p>';
            } else {
                 unsupportedHtml += '<p class="text-sm text-gray-500">All claims appear to be supported.</p>';
            }
            unsupportedHtml += '</div>';
            finalHtml += unsupportedHtml;

            // ---  Display the raw context documents used for the analysis ---
            if (result.retrieved_context && result.retrieved_context.length > 0) {
                let contextHtml = '<div class="analysis-card"><h4 class="font-semibold text-gray-400 mb-2">Context Documents Considered</h4>';
                contextHtml += result.retrieved_context.map(s => createSourceDetailHtml(s.source, s.content)).join('');
                contextHtml += '</div>';
                finalHtml += contextHtml;
            }

            analysisContent.innerHTML = finalHtml;
        }

        async function handleUpload(e) {
            e.preventDefault();
            const file = fileInput.files[0];
            if (!file) {
                uploadStatus.textContent = 'Please select a file.';
                uploadStatus.className = 'mt-2 text-sm text-red-400'; return;
            }

            // Disable upload button and show initial status
            uploadButton.disabled = true;
            uploadButton.textContent = 'Processing...';
            uploadStatus.textContent = 'Uploading file...';
            uploadStatus.className = 'mt-2 text-sm text-blue-400';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await response.json();

                if (response.ok && result.requires_ocr) {
                    // Show OCR processing message instead of progress bar
                    uploadStatus.textContent = "OCR processing underway because normal parsing didn't work. Please wait...";
                    uploadStatus.className = 'mt-2 text-sm text-yellow-400';
                    ocrProgress.classList.add('hidden'); // Hide progress bar

                    // Poll backend for OCR status
                    pollOCRStatus(result.filename);

                } else {
                    // Normal processing completed
                    const message = response.ok ? result.success : (result.error || 'Upload failed.');
                    const colorClass = response.ok ? 'text-green-400' : 'text-red-400';
                    uploadStatus.textContent = message;
                    uploadStatus.className = `mt-2 text-sm ${colorClass}`;
                }
            } catch (error) {
                uploadStatus.textContent = 'An error occurred during upload.';
                uploadStatus.className = 'mt-2 text-sm text-red-400';
            } finally {
                // Re-enable upload button
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload & Process';
            }
        }

        async function simulateOCRProgress(filename) {
            const progressSteps = [
                { progress: 10, text: 'Initializing OCR...' },
                { progress: 25, text: 'Converting PDF pages to images...' },
                { progress: 40, text: 'Processing page 1 of 3...' },
                { progress: 60, text: 'Processing page 2 of 3...' },
                { progress: 80, text: 'Processing page 3 of 3...' },
                { progress: 90, text: 'Extracting text from images...' },
                { progress: 100, text: 'Finalizing document processing...' }
            ];

            for (let step of progressSteps) {
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                ocrProgressBar.style.width = `${step.progress}%`;
                ocrStatusText.textContent = step.text;
            }

            // Hide OCR progress and show success
            await new Promise(resolve => setTimeout(resolve, 500));
            ocrProgress.classList.add('hidden');
            uploadStatus.textContent = `File '${filename}' uploaded and processed successfully with OCR!`;
            uploadStatus.className = 'mt-2 text-sm text-green-400';
        }

        async function pollOCRStatus(filename) {
            const pollInterval = 2000; // 2 seconds
            return new Promise((resolve, reject) => {
                const intervalId = setInterval(async () => {
                    try {
                        const response = await fetch(`/api/ocr_status/${filename}`);
                        const data = await response.json();
                        if (data.status === "done") {
                            clearInterval(intervalId);
                            ocrProgress.classList.add('hidden');
                            uploadStatus.textContent = `File '${filename}' uploaded and processed successfully with OCR!`;
                            uploadStatus.className = 'mt-2 text-sm text-green-400';
                            resolve();
                        } else if (data.status === "not_found") {
                            clearInterval(intervalId);
                            ocrProgress.classList.add('hidden');
                            uploadStatus.textContent = `OCR status not found for file '${filename}'.`;
                            uploadStatus.className = 'mt-2 text-sm text-red-400';
                            reject(new Error("OCR status not found"));
                        } else {
                            // Update progress bar or status text if desired here
                            ocrStatusText.textContent = `OCR processing... Please wait.`;
                            ocrProgressBar.style.width = '50%'; // Show progress bar at 50%
                        }
                    } catch (error) {
                        clearInterval(intervalId);
                        ocrProgress.classList.add('hidden');
                        uploadStatus.textContent = 'Error checking OCR status.';
                        uploadStatus.className = 'mt-2 text-sm text-red-400';
                        reject(error);
                    }
                }, pollInterval);
            });
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                questionsCounter.textContent = stats.questions_asked;
                reportsCounter.textContent = stats.reports_generated;
            } catch (error) {
                console.error('Failed to fetch stats:', error);
            }
        }

        // --- Event Listeners ---
        draftEditor.addEventListener('input', debouncedAnalyze);
        uploadForm.addEventListener('submit', handleUpload);
        questionForm.addEventListener('submit', askQuestion);
        exportButton.addEventListener('click', exportReport);
        document.addEventListener('DOMContentLoaded', updateStats);
    </script>
</body>
</html>
